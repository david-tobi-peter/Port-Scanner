import type { IProbeResult, IVulnerability } from "../shared/types.js";

export class VulnerabilityAnalyzer {
  analyze(result: IProbeResult): IVulnerability[] {
    const vulnerabilities: IVulnerability[] = [];

    const isLocalhost = result.hostname === "localhost" || result.hostname === "127.0.0.1" || result.hostname === "::1";

    this.checkInsecureProtocols(result, vulnerabilities, isLocalhost);
    this.checkExposedAPIs(result, vulnerabilities, isLocalhost);
    this.checkExposedDatabases(result, vulnerabilities, isLocalhost);
    this.checkKubernetesExposure(result, vulnerabilities, isLocalhost);
    this.checkManagementInterfaces(result, vulnerabilities, isLocalhost);
    this.checkDevServers(result, vulnerabilities, isLocalhost);
    this.checkVersionDisclosure(result, vulnerabilities, isLocalhost);
    this.checkUncommonPorts(result, vulnerabilities, isLocalhost);

    return vulnerabilities;
  }

  private checkInsecureProtocols(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    if (result.port === 23 && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "MEDIUM" : "CRITICAL",
        title: "Telnet Service Detected",
        description: "Telnet transmits data, including credentials, in plaintext",
        recommendation: "Consider replacing with a secure remote protocol such as SSH",
      });
    }

    if (result.port === 21 && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "LOW" : "HIGH",
        title: "FTP Service Detected",
        description: "FTP transmits credentials in plaintext",
        recommendation: "Use a secure alternative such as SFTP or FTPS",
      });
    }
  }

  private checkExposedAPIs(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    if (result.port === 2375 && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "LOW" : "CRITICAL",
        title: "Unauthenticated API Endpoint Detected",
        description: "API endpoint allows full access without authentication",
        recommendation: "Secure the API with TLS and authentication or restrict access",
      });
    }
  }

  private checkExposedDatabases(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    const dbPorts = [3306, 5432, 27017, 6379, 1433, 5984, 9042];

    if (dbPorts.includes(result.port) && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "INFO" : "HIGH",
        title: isLocalhost ? "Local Database Service Detected" : "Database Service Accessible",
        description: isLocalhost
          ? "Database service is running locally"
          : "Database is accessible from the network, increasing attack surface",
        recommendation: isLocalhost
          ? "Ensure this service is not exposed beyond the local system"
          : "Restrict database access via firewall or network controls",
      });
    }
  }

  private checkKubernetesExposure(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    if (result.port === 6443 && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "LOW" : "HIGH",
        title: "Kubernetes API Detected",
        description: isLocalhost
          ? "Local Kubernetes API is running"
          : "Kubernetes API is publicly accessible",
        recommendation: isLocalhost
          ? "Verify local usage is intended"
          : "Restrict access and enforce strong authentication",
      });
    }
  }

  private checkManagementInterfaces(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    const mgmtPorts = [
      { port: 9090, service: "Monitoring" },
      { port: 15672, service: "Management" },
      { port: 5601, service: "Dashboard" },
    ];

    for (const { port, service } of mgmtPorts) {
      if (result.port === port && result.state === "OPEN") {
        vulns.push({
          severity: isLocalhost ? "INFO" : "MEDIUM",
          title: `${service} Interface Detected`,
          description: isLocalhost
            ? "Local management interface is running"
            : "Management interface is accessible from the network",
          recommendation: isLocalhost
            ? "Verify local usage is intended"
            : "Restrict access via network controls or authentication",
        });
      }
    }
  }

  private checkDevServers(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    const devPorts = [3000, 3001, 4200, 5000, 8000, 9000];

    if (devPorts.includes(result.port) && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "INFO" : "MEDIUM",
        title: "Development Server Detected",
        description: isLocalhost
          ? "Port commonly used for development servers is open locally"
          : "Port commonly used for development servers is open externally",
        recommendation: "Verify that this is intentional and secured appropriately",
      });
    }
  }

  private checkVersionDisclosure(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    if (result.port === 22 && result.fingerprint?.banner && result.state === "OPEN") {
      vulns.push({
        severity: isLocalhost ? "INFO" : "LOW",
        title: "SSH Version Exposure",
        description: "SSH server version is visible",
        recommendation: "Consider hiding version information in the SSH configuration",
      });
    }

    if ([80, 8080, 443, 8443].includes(result.port) && result.fingerprint?.version) {
      vulns.push({
        severity: isLocalhost ? "INFO" : "LOW",
        title: "Web Server Version Exposure",
        description: "Web server version is exposed in headers",
        recommendation: "Consider hiding version information in server configuration",
      });
    }
  }

  private checkUncommonPorts(result: IProbeResult, vulns: IVulnerability[], isLocalhost: boolean): void {
    if (result.port > 49152 && result.state === "OPEN" && result.stability === "STABLE") {
      vulns.push({
        severity: isLocalhost ? "INFO" : "INFO",
        title: "Service on High Port Range",
        description: isLocalhost
          ? "Service is running on a high port locally"
          : "Service is running on a port typically reserved for ephemeral/private use",
        recommendation: "Verify this is intentional; may indicate misconfiguration or unusual service",
      });
    }
  }
}
