import type { IProbeResult, IVulnerability } from "../shared/types.js";

export class VulnerabilityAnalyzer {
  analyze(result: IProbeResult): IVulnerability[] {
    const vulnerabilities: IVulnerability[] = [];

    this.checkInsecureProtocols(result, vulnerabilities);
    this.checkExposedAPIs(result, vulnerabilities);
    this.checkExposedDatabases(result, vulnerabilities);
    this.checkKubernetesExposure(result, vulnerabilities);
    this.checkManagementInterfaces(result, vulnerabilities);
    this.checkDevServers(result, vulnerabilities);
    this.checkVersionDisclosure(result, vulnerabilities);
    this.checkUncommonPorts(result, vulnerabilities);

    return vulnerabilities;
  }

  private checkInsecureProtocols(result: IProbeResult, vulns: IVulnerability[]): void {
    if (result.port === 23 && result.state === "OPEN") {
      vulns.push({
        severity: "CRITICAL",
        title: "Telnet Service Detected",
        description: "Telnet transmits all data including passwords in plaintext",
        recommendation: "Disable Telnet and use SSH (port 22) instead",
      });
    }

    if (result.port === 21 && result.state === "OPEN") {
      vulns.push({
        severity: "HIGH",
        title: "FTP Service Detected",
        description: "FTP transmits credentials in plaintext",
        recommendation: "Use SFTP (SSH File Transfer Protocol) or FTPS instead",
      });
    }
  }

  private checkExposedAPIs(result: IProbeResult, vulns: IVulnerability[]): void {
    if (result.port === 2375 && result.state === "OPEN") {
      vulns.push({
        severity: "CRITICAL",
        title: "Docker API Exposed Without TLS",
        description: "Unauthenticated Docker API allows complete container control",
        recommendation: "Use Docker TLS (port 2376) or restrict access via firewall",
      });
    }
  }

  private checkExposedDatabases(result: IProbeResult, vulns: IVulnerability[]): void {
    const dbPorts = [3306, 5432, 27017, 6379, 1433, 5984, 9042];

    if (dbPorts.includes(result.port) && result.state === "OPEN") {
      vulns.push({
        severity: "HIGH",
        title: `${result.info.service} Database Exposed`,
        description: "Database is accessible from the internet, increasing attack surface",
        recommendation: "Restrict database access to localhost or specific IPs via firewall",
      });
    }
  }

  private checkKubernetesExposure(result: IProbeResult, vulns: IVulnerability[]): void {
    if (result.port === 6443 && result.state === "OPEN") {
      vulns.push({
        severity: "HIGH",
        title: "Kubernetes API Server Exposed",
        description: "K8s API server is publicly accessible",
        recommendation: "Restrict access via network policies and use strong authentication",
      });
    }
  }

  private checkManagementInterfaces(result: IProbeResult, vulns: IVulnerability[]): void {
    const mgmtPorts = [
      { port: 9090, service: "Prometheus" },
      { port: 15672, service: "RabbitMQ Management" },
      { port: 5601, service: "Kibana" },
    ];

    for (const { port, service } of mgmtPorts) {
      if (result.port === port && result.state === "OPEN") {
        vulns.push({
          severity: "MEDIUM",
          title: `${service} Management Interface Exposed`,
          description: "Management interfaces should not be publicly accessible",
          recommendation: "Restrict access via VPN, firewall, or authentication",
        });
      }
    }
  }

  private checkDevServers(result: IProbeResult, vulns: IVulnerability[]): void {
    const devPorts = [3000, 3001, 4200, 5000, 8000, 9000];

    if (devPorts.includes(result.port) && result.state === "OPEN") {
      vulns.push({
        severity: "MEDIUM",
        title: "Development Server Port Open",
        description: "Common development server port detected in production",
        recommendation: "Ensure this is intentional; dev servers may lack security hardening",
      });
    }
  }

  private checkVersionDisclosure(result: IProbeResult, vulns: IVulnerability[]): void {
    if (result.port === 22 && result.fingerprint?.banner && result.state === "OPEN") {
      vulns.push({
        severity: "LOW",
        title: "SSH Banner Disclosure",
        description: "SSH server version is visible, aiding reconnaissance",
        recommendation: "Consider using DebianBanner no in sshd_config",
      });
    }

    if ([80, 8080, 443, 8443].includes(result.port) && result.fingerprint?.version) {
      vulns.push({
        severity: "LOW",
        title: "HTTP Server Version Disclosure",
        description: "Web server version is exposed in headers",
        recommendation: "Configure server to hide version information (server_tokens off in nginx)",
      });
    }
  }

  private checkUncommonPorts(result: IProbeResult, vulns: IVulnerability[]): void {
    if (result.port > 49152 && result.state === "OPEN" && result.stability === "STABLE") {
      vulns.push({
        severity: "INFO",
        title: "Service on Ephemeral Port Range",
        description: "Service running on port typically reserved for dynamic/private use",
        recommendation: "Verify this is intentional; may indicate backdoor or misconfiguration",
      });
    }
  }
}